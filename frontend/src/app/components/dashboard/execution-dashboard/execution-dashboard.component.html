<div class="execution-dashboard">
  <!-- Header -->
  <div class="dashboard-header">
    <h2>Execution Dashboard</h2>
    <div class="header-actions">
      <button class="btn btn-outline-primary btn-sm" (click)="onRefresh()" [disabled]="isLoading">
        <i class="bi bi-arrow-clockwise" [class.spin]="isLoading"></i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-container">
    <div class="row g-3">
      <div class="col-md-4">
        <label for="statusFilter" class="form-label">Status</label>
        <select id="statusFilter" class="form-select" [formControl]="statusFilter">
          <option *ngFor="let status of statuses" [value]="status.value">
            {{ status.label }}
          </option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="toolFilter" class="form-label">Tool</label>
        <select id="toolFilter" class="form-select" [formControl]="toolFilter">
          <option *ngFor="let tool of tools" [value]="tool.value">
            {{ tool.label }}
          </option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="searchTerm" class="form-label">Search</label>
        <div class="input-group">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input 
            type="text" 
            id="searchTerm" 
            class="form-control" 
            placeholder="Search executions..."
            [formControl]="searchTerm">
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading && !isInitialized" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading execution history...</p>
  </div>

  <!-- Active Executions -->
  <div *ngIf="activeExecutions.length > 0" class="mt-4">
    <h5 class="mb-3">
      <i class="bi bi-lightning-charge-fill text-warning"></i>
      Active Executions ({{ activeExecutions.length }})
    </h5>
    
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Tool</th>
            <th>Status</th>
            <th>Progress</th>
            <th>Duration</th>
            <th>Started</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let exec of activeExecutions" (click)="onSelectExecution(exec)" class="cursor-pointer">
            <td>
              <div class="d-flex align-items-center">
                <i class="bi bi-gear-fill me-2 text-primary"></i>
                <div>
                  <div class="fw-medium">{{ exec.tool }}</div>
                  <small class="text-muted">{{ exec.id | slice:0:8 }}...</small>
                </div>
              </div>
            </td>
            <td>
              <span class="badge" [ngClass]="getStatusBadgeClass(exec.status)">
                {{ exec.status | titlecase }}
              </span>
            </td>
            <td>
              <div class="progress" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     [style.width.%]="exec.progress"
                     [attr.aria-valuenow]="exec.progress" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                </div>
              </div>
              <small class="text-muted">{{ exec.progress }}%</small>
            </td>
            <td>{{ formatDuration(new Date().getTime() - exec.startTime.getTime()) }}</td>
            <td>{{ formatTimestamp(exec.startTime) | date:'short' }}</td>
            <td>
              <button class="btn btn-sm btn-outline-danger" 
                      (click)="$event.stopPropagation(); onCancelExecution(exec.id)"
                      [disabled]="!['pending', 'running'].includes(exec.status)">
                <i class="bi bi-x-circle"></i> Cancel
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Execution History -->
  <div class="mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5>
        <i class="bi bi-clock-history text-secondary"></i>
        Execution History ({{ filteredExecutions.length }})
      </h5>
      <div class="d-flex align-items-center">
        <label class="me-2 mb-0 small text-muted">Show</label>
        <select class="form-select form-select-sm" style="width: auto;" (change)="onItemsPerPageChange($event.target.value)">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>
    
    <div *ngIf="filteredExecutions.length === 0" class="text-center py-5 bg-light rounded">
      <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
      <p class="mt-3 text-muted">No executions found matching your filters.</p>
    </div>
    
    <div *ngIf="filteredExecutions.length > 0" class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Tool</th>
            <th>Status</th>
            <th>Duration</th>
            <th>Started</th>
            <th>Completed</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let exec of filteredExecutions | slice: (currentPage-1) * itemsPerPage : currentPage * itemsPerPage" 
              (click)="onSelectExecution(exec)" 
              class="cursor-pointer"
              [ngClass]="{
                'table-success': exec.status === 'completed',
                'table-danger': exec.status === 'failed',
                'table-warning': exec.status === 'cancelled'
              }">
            <td>
              <div class="d-flex align-items-center">
                <i class="bi bi-gear-fill me-2" [ngClass]="{
                  'text-primary': exec.status === 'running',
                  'text-success': exec.status === 'completed',
                  'text-danger': exec.status === 'failed',
                  'text-warning': exec.status === 'cancelled',
                  'text-secondary': exec.status === 'pending'
                }"></i>
                <div>
                  <div class="fw-medium">{{ exec.tool }}</div>
                  <small class="text-muted">{{ exec.id | slice:0:8 }}...</small>
                </div>
              </div>
            </td>
            <td>
              <span class="badge" [ngClass]="getStatusBadgeClass(exec.status)">
                {{ exec.status | titlecase }}
              </span>
            </td>
            <td>
              <span [ngbTooltip]="'Started: ' + (exec.startTime | date:'medium') + '\n' + 
                                 'Ended: ' + (exec.endTime | date:'medium')">
                {{ exec.duration ? formatDuration(exec.duration) : 'N/A' }}
              </span>
            </td>
            <td>{{ exec.startTime | date:'short' }}</td>
            <td>{{ exec.endTime ? (exec.endTime | date:'short') : 'N/A' }}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" (click)="$event.stopPropagation(); onSelectExecution(exec)">
                <i class="bi bi-eye"></i> Details
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      
      <!-- Pagination -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted small">
          Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to 
          {{ Math.min(currentPage * itemsPerPage, filteredExecutions.length) }} of 
          {{ filteredExecutions.length }} entries
        </div>
        <ngb-pagination 
          [collectionSize]="filteredExecutions.length" 
          [(page)]="currentPage"
          [pageSize]="itemsPerPage"
          [maxSize]="5"
          [rotate]="true"
          [ellipses]="true"
          [boundaryLinks]="true"
          (pageChange)="onPageChange($event)"
          class="d-flex justify-content-end">
        </ngb-pagination>
      </div>
    </div>
  </div>
</div>

<!-- Execution Details Modal -->
<ng-template #executionDetails let-modal>
  <div class="modal-header">
    <h5 class="modal-title">
      <i class="bi bi-info-circle-fill me-2" [ngClass]="{
        'text-primary': selectedExecution?.status === 'running',
        'text-success': selectedExecution?.status === 'completed',
        'text-danger': selectedExecution?.status === 'failed',
        'text-warning': selectedExecution?.status === 'cancelled'
      }"></i>
      Execution Details
    </h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Close"></button>
  </div>
  
  <div class="modal-body" *ngIf="selectedExecution">
    <div class="row mb-4">
      <div class="col-md-6">
        <h6>Overview</h6>
        <table class="table table-sm">
          <tbody>
            <tr>
              <th scope="row" style="width: 40%;">Execution ID</th>
              <td>{{ selectedExecution.id }}</td>
            </tr>
            <tr>
              <th scope="row">Tool</th>
              <td>{{ selectedExecution.tool }}</td>
            </tr>
            <tr>
              <th scope="row">Status</th>
              <td>
                <span class="badge" [ngClass]="getStatusBadgeClass(selectedExecution.status)">
                  {{ selectedExecution.status | titlecase }}
                </span>
              </td>
            </tr>
            <tr>
              <th scope="row">Started</th>
              <td>{{ formatTimestamp(selectedExecution.startTime) }}</td>
            </tr>
            <tr *ngIf="selectedExecution.endTime">
              <th scope="row">Completed</th>
              <td>{{ formatTimestamp(selectedExecution.endTime) }}</td>
            </tr>
            <tr *ngIf="selectedExecution.duration">
              <th scope="row">Duration</th>
              <td>{{ formatDuration(selectedExecution.duration) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="col-md-6">
        <h6>Progress</h6>
        <div *ngIf="selectedExecution.status === 'running'" class="mb-3">
          <div class="progress" style="height: 10px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" 
                 [style.width.%]="selectedExecution.progress"
                 [attr.aria-valuenow]="selectedExecution.progress" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
            </div>
          </div>
          <div class="text-end mt-1">
            <small class="text-muted">{{ selectedExecution.progress }}% complete</small>
          </div>
        </div>
        
        <div *ngIf="selectedExecution.message" class="alert alert-info mb-3">
          <i class="bi bi-info-circle me-2"></i>
          {{ selectedExecution.message }}
        </div>
        
        <div *ngIf="selectedExecution.error" class="alert alert-danger">
          <h6 class="alert-heading">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            Error
          </h6>
          <p class="mb-0">{{ selectedExecution.error }}</p>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-12">
        <h6>Result</h6>
        <div *ngIf="selectedExecution.result" class="result-container">
          <pre *ngIf="isObject(selectedExecution.result)">{{ selectedExecution.result | json }}</pre>
          <div *ngIf="!isObject(selectedExecution.result)" class="p-3 bg-light rounded">
            {{ selectedExecution.result }}
          </div>
        </div>
        <div *ngIf="!selectedExecution.result" class="text-muted">
          No result data available.
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">
      <i class="bi bi-x-lg"></i> Close
    </button>
    <button *ngIf="['pending', 'running'].includes(selectedExecution.status)" 
            type="button" 
            class="btn btn-danger"
            (click)="onCancelExecution(selectedExecution.id); modal.dismiss()">
      <i class="bi bi-x-circle"></i> Cancel Execution
    </button>
  </div>
</ng-template>
