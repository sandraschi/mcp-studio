{% extends "base.html" %}

{% block title %}Client Details - MCP Studio{% endblock %}

{% block content %}
<div x-data="clientDetail()" x-init="init()" class="space-y-6">
    <!-- Page header with back button -->
    <div class="flex items-center">
        <a href="/clients" class="mr-4 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                <span x-text="client.name || 'Loading...'"></span>
                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" 
                      :class="{
                        'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': configInfo && configInfo.config_exists,
                        'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200': !configInfo || !configInfo.config_exists,
                      }">
                    <span x-text="configInfo && configInfo.config_exists ? 'Active' : 'Not Configured'"></span>
                </span>
            </h1>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400" x-text="client.short_description || ''"></p>
        </div>
    </div>

    <!-- Client details tabs -->
    <div class="border-b border-gray-200 dark:border-gray-700">
        <nav class="-mb-px flex space-x-8">
            <button @click="activeTab = 'overview'" 
                    :class="activeTab === 'overview' ? 'border-primary-500 text-primary-600 dark:text-primary-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                <i class="fas fa-info-circle mr-2"></i>
                Overview
            </button>
            <button @click="activeTab = 'servers'" 
                    :class="activeTab === 'servers' ? 'border-primary-500 text-primary-600 dark:text-primary-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                <i class="fas fa-server mr-2"></i>
                Servers
                <span x-show="servers.length > 0" class="ml-1.5 py-0.5 px-1.5 rounded-full text-xs font-medium bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200" x-text="servers.length"></span>
            </button>
            <button @click="activeTab = 'working-sets'" 
                    :class="activeTab === 'working-sets' ? 'border-primary-500 text-primary-600 dark:text-primary-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200'"
                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                <i class="fas fa-layer-group mr-2"></i>
                Working Sets
            </button>
        </nav>
    </div>

    <!-- Tab content -->
    <div>
        <!-- Overview tab -->
        <div x-show="activeTab === 'overview'" x-transition>
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Client Information</h3>
                    <div class="mt-5 border-t border-gray-200 dark:border-gray-700">
                        <dl class="sm:divide-y sm:divide-gray-200 dark:divide-gray-700">
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Client ID</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-200 sm:mt-0 sm:col-span-2" x-text="client.id || 'N/A'"></dd>
                            </div>
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Type</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-200 sm:mt-0 sm:col-span-2" x-text="client.client_type || 'N/A'"></dd>
                            </div>
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Platform</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-200 sm:mt-0 sm:col-span-2" x-text="client.platform || 'N/A'"></dd>
                            </div>
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Status</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-200 sm:mt-0 sm:col-span-2" x-text="client.status || 'N/A'"></dd>
                            </div>
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4" x-show="client.homepage">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Homepage</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-200 sm:mt-0 sm:col-span-2">
                                    <a :href="client.homepage" target="_blank" class="text-primary-600 hover:text-primary-500 dark:text-primary-400" x-text="client.homepage"></a>
                                </dd>
                            </div>
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Description</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-200 sm:mt-0 sm:col-span-2" x-text="client.full_description || 'No description provided'"></dd>
                            </div>
                            <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4" x-show="configInfo">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Config Path</dt>
                                <dd class="mt-1 text-sm text-gray-900 dark:text-gray-200 sm:mt-0 sm:col-span-2" x-text="configInfo.config_path || 'N/A'"></dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Servers tab -->
        <div x-show="activeTab === 'servers'" x-transition>
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Configured Servers</h3>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">MCP servers configured for this client</p>
                </div>
                <div class="bg-white dark:bg-gray-800 overflow-hidden">
                    <div x-show="servers.length === 0" class="p-6 text-center text-gray-500 dark:text-gray-400">
                        <i class="fas fa-server text-4xl mb-2 opacity-50"></i>
                        <p>No servers configured</p>
                        <p class="mt-1 text-sm">This client doesn't have any MCP servers configured yet.</p>
                    </div>
                    
                    <div x-show="servers.length > 0" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <template x-for="server in servers" :key="server.id">
                            <div class="px-6 py-4 hover:bg-gray-50 dark:hover:bg-gray-700">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white" x-text="server.name"></div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400" x-text="server.command"></div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Working Sets tab -->
        <div x-show="activeTab === 'working-sets'" x-transition>
            <div x-show="!configInfo || !configInfo.config_exists" class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-6">
                <div class="flex">
                    <i class="fas fa-exclamation-triangle text-yellow-400 mr-3"></i>
                    <div>
                        <h3 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Config Not Found</h3>
                        <p class="mt-1 text-sm text-yellow-700 dark:text-yellow-300">This client's configuration file was not found. Working sets are only available for clients with existing configurations.</p>
                    </div>
                </div>
            </div>

            <div x-show="configInfo && configInfo.config_exists">
                <!-- Current Active Servers -->
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden mb-6">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Current Active Servers</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400" x-text="`${currentServers.length} server(s) currently active`"></p>
                    </div>
                    <div class="px-6 py-4">
                        <div x-show="currentServers.length === 0" class="text-sm text-gray-500 dark:text-gray-400">No servers currently active</div>
                        <ul x-show="currentServers.length > 0" class="list-disc list-inside space-y-1">
                            <template x-for="server in currentServers" :key="server">
                                <li class="text-sm text-gray-900 dark:text-gray-200" x-text="server"></li>
                            </template>
                        </ul>
                    </div>
                </div>

                <!-- Working Sets -->
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
                    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Working Sets</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Switch between different sets of servers</p>
                    </div>
                    <div class="p-6">
                        <div x-show="workingSets.length === 0" class="text-center text-gray-500 dark:text-gray-400 py-8">
                            <i class="fas fa-layer-group text-4xl mb-2 opacity-50"></i>
                            <p>No working sets available</p>
                            <p class="mt-1 text-sm">Create working set templates in the templates directory.</p>
                        </div>
                        
                        <div x-show="workingSets.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <template x-for="ws in workingSets" :key="ws.id">
                                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:border-primary-300 dark:hover:border-primary-600 transition-colors"
                                     :class="{'ring-2 ring-primary-500': ws.id === currentWorkingSet}">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex items-center">
                                            <span class="text-2xl mr-2" x-text="ws.icon || 'ðŸ”§'"></span>
                                            <div>
                                                <h4 class="text-sm font-medium text-gray-900 dark:text-white" x-text="ws.name"></h4>
                                                <p class="text-xs text-gray-500 dark:text-gray-400" x-text="ws.category"></p>
                                            </div>
                                        </div>
                                        <span x-show="ws.id === currentWorkingSet" 
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                            Active
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" x-text="ws.description"></p>
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-3" x-text="`${ws.server_count || 0} server(s)`"></div>
                                    <div class="flex space-x-2">
                                        <button @click="previewWorkingSet(ws.id)" 
                                                class="flex-1 px-3 py-1.5 text-xs font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                                            Preview
                                        </button>
                                        <button @click="activateWorkingSet(ws.id)" 
                                                :disabled="ws.id === currentWorkingSet"
                                                :class="ws.id === currentWorkingSet ? 'opacity-50 cursor-not-allowed' : ''"
                                                class="flex-1 px-3 py-1.5 text-xs font-medium text-white bg-primary-600 hover:bg-primary-700 rounded">
                                            Activate
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function clientDetail() {
    return {
        loading: true,
        activeTab: 'overview',
        client: {},
        servers: [],
        workingSets: [],
        currentWorkingSet: null,
        currentServers: [],
        configInfo: null,
        previewData: null,
        
        init() {
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            if (tab && ['overview', 'servers', 'working-sets'].includes(tab)) {
                this.activeTab = tab;
            }
            
            this.loadClient();
            
            this.$watch('activeTab', (newTab) => {
                const url = new URL(window.location);
                url.searchParams.set('tab', newTab);
                window.history.pushState({}, '', url);
                
                if (newTab === 'servers') {
                    this.loadServers();
                } else if (newTab === 'working-sets') {
                    this.loadWorkingSets();
                }
            });
        },
        
        async loadClient() {
            try {
                this.loading = true;
                const clientId = window.location.pathname.split('/').pop();
                const response = await fetch(`/api/v1/clients/${clientId}`);
                if (!response.ok) throw new Error('Failed to load client');
                this.client = await response.json();
                
                // Load config info
                const configResponse = await fetch(`/api/v1/clients/${clientId}/config`);
                if (configResponse.ok) {
                    this.configInfo = await configResponse.json();
                    this.currentServers = this.configInfo.current_servers || [];
                }
                
                if (this.activeTab === 'servers') {
                    await this.loadServers();
                } else if (this.activeTab === 'working-sets') {
                    await this.loadWorkingSets();
                }
            } catch (error) {
                console.error('Error loading client:', error);
                this.showNotification('Failed to load client details', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        async loadServers() {
            try {
                const clientId = window.location.pathname.split('/').pop();
                const response = await fetch(`/api/v1/clients/${clientId}/servers`);
                if (!response.ok) throw new Error('Failed to load servers');
                const data = await response.json();
                this.servers = data.servers || [];
            } catch (error) {
                console.error('Error loading servers:', error);
            }
        },
        
        async loadWorkingSets() {
            try {
                const clientId = window.location.pathname.split('/').pop();
                const response = await fetch(`/api/v1/clients/${clientId}/working-sets`);
                if (!response.ok) throw new Error('Failed to load working sets');
                const data = await response.json();
                this.workingSets = data.working_sets || [];
                this.currentWorkingSet = data.current_working_set;
            } catch (error) {
                console.error('Error loading working sets:', error);
            }
        },
        
        async previewWorkingSet(setId) {
            try {
                const clientId = window.location.pathname.split('/').pop();
                const response = await fetch(`/api/v1/clients/${clientId}/working-sets/${setId}/preview`);
                if (!response.ok) throw new Error('Failed to preview working set');
                const preview = await response.json();
                
                // Show preview in modal or alert
                const message = `Current: ${preview.current_servers.join(', ') || 'None'}\n` +
                              `New: ${preview.new_servers.join(', ') || 'None'}\n` +
                              `Added: ${preview.added_servers.join(', ') || 'None'}\n` +
                              `Removed: ${preview.removed_servers.join(', ') || 'None'}`;
                alert(message);
            } catch (error) {
                console.error('Error previewing working set:', error);
                this.showNotification('Failed to preview working set', 'error');
            }
        },
        
        async activateWorkingSet(setId) {
            if (!confirm('Are you sure you want to switch to this working set? A backup will be created.')) {
                return;
            }
            
            try {
                const clientId = window.location.pathname.split('/').pop();
                const response = await fetch(`/api/v1/clients/${clientId}/working-sets/${setId}/activate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({create_backup: true})
                });
                
                if (!response.ok) throw new Error('Failed to activate working set');
                const result = await response.json();
                
                this.showNotification('Working set activated successfully', 'success');
                await this.loadWorkingSets();
                await this.loadClient(); // Reload to get updated servers
            } catch (error) {
                console.error('Error activating working set:', error);
                this.showNotification('Failed to activate working set', 'error');
            }
        },
        
        showNotification(message, type = 'info') {
            console.log(`[${type}] ${message}`);
            // TODO: Implement proper notification system
        }
    };
}
</script>
{% endblock %}
