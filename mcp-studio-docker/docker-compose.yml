name: mcp-studio
version: '3.8'

services:
  # Traefik Reverse Proxy & Authentication
  traefik:
    image: traefik:v3.0
    container_name: traefik
    command:
      - "--api.insecure=true" # Dashboard on 8080 (don't expose publicly)
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      # OIDC Plugin Configuration
      # NOTE: Using the module for ID 6613338ea28c508f411a44d5
      - "--experimental.plugins.traefik-oidc.modulename=github.com/noverby/traefik-oidc"
      - "--experimental.plugins.traefik-oidc.version=v0.0.4"
    ports:
      - "80:80" # Public HTTP
      - "8090:8080" # Traefik Dashboard (Internal/Private)
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - mcp-studio-network

  mcp-studio-frontend:
    build:
      context: ..
      dockerfile: mcp-studio-docker/Dockerfile
    image: mcp-studio:latest
    container_name: mcp-studio-frontend
    # Temporary debugging access
    ports:
      - "8330:8001"
    volumes:
      - "${REPOS_DIR:-D:/Dev/repos}:/app/repos:rw"
      - "${APPDATA}:/host/appdata:ro"
      - "${USERPROFILE:-/tmp}:/host/home:ro"
      - "../backend:/app/backend"
      - "./logs:/app/logs"
      - "./data:/app/data"
    environment:
      - PORT=8001
      - REPOS_DIR=/app/repos
      - USERPROFILE=${USERPROFILE:-/tmp}
      - OLLAMA_URL=http://host.docker.internal:11434
      - LM_STUDIO_URL=${LM_STUDIO_URL:-http://host.docker.internal:1234}
      - VLLM_URL=${VLLM_URL:-http://host.docker.internal:8000}
    restart: unless-stopped
    networks:
      - mcp-studio-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Traefik Labels for OIDC
    labels:
      - "traefik.enable=true"
      # Router Config (Change 'mcp-studio.localhost' to your actual domain)
      - "traefik.http.routers.mcp-studio-frontend.rule=Host(`mcp-studio.localhost`)"
      - "traefik.http.routers.mcp-studio-frontend.entrypoints=web"
      - "traefik.http.routers.mcp-studio-frontend.middlewares=oidc-auth"
      # Middleware Config (OIDC)
      - "traefik.http.middlewares.oidc-auth.plugin.traefik-oidc.Issuer=${OIDC_ISSUER:-https://accounts.google.com}"
      - "traefik.http.middlewares.oidc-auth.plugin.traefik-oidc.ClientID=${OIDC_CLIENT_ID:-changeme}"
      - "traefik.http.middlewares.oidc-auth.plugin.traefik-oidc.ClientSecret=${OIDC_CLIENT_SECRET:-changeme}"
      - "traefik.http.middlewares.oidc-auth.plugin.traefik-oidc.BaseUrl=${OIDC_BASE_URL:-http://mcp-studio.localhost}"
      # Service Config
      - "traefik.http.services.mcp-studio-frontend.loadbalancer.server.port=8001"

networks:
  mcp-studio-network:
    driver: bridge
